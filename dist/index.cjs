"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const a=require("lodash"),u=require("typedi"),l=require("react");function y(s,t,e,i){var r=arguments.length,n=r<3?t:i===null?i=Object.getOwnPropertyDescriptor(t,e):i,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(s,t,e,i);else for(var h=s.length-1;h>=0;h--)(c=s[h])&&(n=(r<3?c(n):r>3?c(t,e,n):c(t,e))||n);return r>3&&n&&Object.defineProperty(t,e,n),n}function w(s,t){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(s,t)}function S(s,t,e,i){function r(n){return n instanceof e?n:new e(function(c){c(n)})}return new(e||(e=Promise))(function(n,c){function h(o){try{d(i.next(o))}catch(f){c(f)}}function g(o){try{d(i.throw(o))}catch(f){c(f)}}function d(o){o.done?n(o.value):r(o.value).then(h,g)}d((i=i.apply(s,t||[])).next())})}let m=class{constructor(){this._actions=void 0,this._state=void 0,this._defaultContext={state:this._state,dispatch:()=>({})},this._isInit=!1,this._middlewares=[],this.context=l.createContext(this._defaultContext),this.storeReducer=(t,e)=>(this._state=a.cloneDeep(t),this.onTry(()=>this._actions[e.type.split("/")[0]][e.type](e.payload)),this._state),this.storeProvider=({children:t})=>{const[e,i]=this.useReducerWithMiddleware(),r=l.useMemo(()=>({state:e,dispatch:i}),[e,i]);return l.createElement(this.context.Provider,{value:Object.seal(r),children:t})}}init(t,e){if(this._isInit===!1)return this._isInit=!0,this._actions=e,this._state=a.cloneDeep(t),Object.assign(Object.assign({},this.store),{storeInstance:this})}onTry(t){try{t()}catch(e){console.log(e)}}useReducerWithMiddleware(){const[t,e]=l.useReducer(this.storeReducer,this._state),i=r=>S(this,void 0,void 0,function*(){yield Promise.allSettled(this._middlewares.map(n=>n.action.call(this,{action:r,state:this.proxyState,actions:this.filterAction,dispatch:e})).concat((()=>S(this,void 0,void 0,function*(){return e(r)})).call(this)))});return[this._state,i]}useStore(t){const{dispatch:e}=l.useContext(this.context);return t?[t(this._state),{dispatch:e,actions:this.filterAction}]:[this._state,{dispatch:e,actions:this.filterAction}]}get proxyState(){return new Proxy(Object.seal(this._state),{})}get store(){return{useStore:this.useStore.bind(this),StoreProvider:Object.defineProperty(this.storeProvider,"name",{value:"StoreProvider"})}}getState(){return this._state}setState(t){this._state=a.cloneDeep(Object.assign(Object.assign({},this._state),t))}setMiddleware(...t){return this._middlewares=this._middlewares.concat(t)}createMiddleware(...t){return this.setMiddleware(...t.map(e=>({action:e})))}checkSliceName(t){if(this._state)return t in this._state}get filterAction(){const t=a.cloneDeep(this._actions);for(const e in t)for(const i in t[e])i.includes(`${e}/`)&&(t[e][i]=void 0,delete t[e][i]);return t}};m=y([u.Service("StoreModel")],m);const j=(s,t)=>u.get("StoreModel").init(s,t);let _=class{constructor(){this.storeInstance=null,this._name=null,this._reducers=null,this._sliceActions={}}init(t){if(!t.name)throw Error("The slice name cannot be empty and must be set.");if(this.storeInstance.checkSliceName(t.name))throw Error(`The slice with the name '${t.name}' has already been created. The name '${t.name}' for the slice must be uniq, change another name slice.`);if(!/^[a-zA-Z \d.'-_]+$/g.test(t.name))throw Error(`The incorect name '${t.name}'. The name for the slice must be include only latin char, numbers and '-_.' symbols.`);return this._name=t.name,this._reducers=t.reducers,this.storeInstance.setState({[this._name]:a.cloneDeep(t.initState)}),this}get actions(){return this._sliceActions}get name(){return this._name}get state(){return new Proxy(Object.seal(this.storeInstance.getState()[this.name]),{})}get reducer(){for(const t in this._reducers){const e=this._reducers[t].name;if(!e.includes(`${this.name}/${e}`)){const i=`${this.name}/${e}`,r=this._reducers[t].bind(this);a.assign(this._sliceActions,{[i]:n=>(r(this.state,n),{[this.name]:this.state})}),a.assign(this._sliceActions,{[e]:n=>({type:i,payload:n})})}}return this.state}get sliceStore(){return{[this.name]:this.reducer}}};y([u.Inject("StoreModel"),w("design:type",m)],_.prototype,"storeInstance",void 0);_=y([u.Service({id:"SliceModel",transient:!0})],_);function v(s){return u.get("SliceModel").init(s)}const p=Array,b="isArray"in p?p.isArray:s=>toString.call(s)==="[object Array]",M=typeof document<"u"&&typeof document.getElementsByTagName("body")=="function"?s=>!!s&&toString.call(s)==="[object Function]":s=>!!s&&typeof s=="function",A=(s,t)=>s==null||(t?!1:s==="")||b(s)&&s.length===0,x={array:{IsArray:b},object:{IsEmpty:A,IsFunction:M}};exports.Store=j;exports.Utils=x;exports.createSlice=v;
